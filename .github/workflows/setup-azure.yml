# ──────────────────────────────────────────────────────────────
# Azure Infrastructure Setup — One-time setup script
# Run this once to create all Azure resources
# ──────────────────────────────────────────────────────────────
name: Setup Azure Infrastructure

on:
  workflow_dispatch: # Manual trigger only

env:
  AZURE_RESOURCE_GROUP: ai-interview-rg
  LOCATION: eastasia                    # Allowed region for student subscription
  ACR_NAME: aiinterviewacr             # Must be globally unique
  CONTAINER_ENV_NAME: ai-interview-env
  BACKEND_APP_NAME: ai-interview-backend
  FRONTEND_APP_NAME: ai-interview-frontend

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ── 1. Create Resource Group ─────────────
      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }}

      # ── 2. Create Azure Container Registry (Basic = ~$5/month) ──
      - name: Create Container Registry
        run: |
          az acr create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.ACR_NAME }} \
            --sku Basic \
            --admin-enabled true

      # ── 3. Create Container Apps Environment (free) ──
      - name: Create Container Apps Environment
        run: |
          az containerapp env create \
            --name ${{ env.CONTAINER_ENV_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }}

      # ── 4. Create Backend Container App ──────
      - name: Create Backend Container App
        run: |
          az containerapp create \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_ENV_NAME }} \
            --image mcr.microsoft.com/k8se/quickstart:latest \
            --target-port 8000 \
            --ingress external \
            --min-replicas 0 \
            --max-replicas 1 \
            --cpu 1.0 \
            --memory 2.0Gi \
            --registry-server ${{ env.ACR_NAME }}.azurecr.io \
            --registry-username $(az acr credential show --name ${{ env.ACR_NAME }} --query username -o tsv) \
            --registry-password $(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" -o tsv) \
            --env-vars \
              MONGODB_URL="${{ secrets.MONGODB_URL }}" \
              DATABASE_NAME="ai_interview_platform" \
              JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
              JWT_ALGORITHM="HS256" \
              ACCESS_TOKEN_EXPIRE_MINUTES="1440" \
              GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
              GEMINI_MODEL="gemini-2.5-flash" \
              FRONTEND_URL="https://placeholder.azurecontainerapps.io" \
              EMAIL_PROVIDER="resend" \
              RESEND_API_KEY="${{ secrets.RESEND_API_KEY }}"

      # ── 5. Create Frontend Container App ─────
      - name: Create Frontend Container App
        run: |
          az containerapp create \
            --name ${{ env.FRONTEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_ENV_NAME }} \
            --image mcr.microsoft.com/k8se/quickstart:latest \
            --target-port 80 \
            --ingress external \
            --min-replicas 0 \
            --max-replicas 1 \
            --cpu 0.25 \
            --memory 0.5Gi \
            --registry-server ${{ env.ACR_NAME }}.azurecr.io \
            --registry-username $(az acr credential show --name ${{ env.ACR_NAME }} --query username -o tsv) \
            --registry-password $(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" -o tsv)

      # ── 6. Output URLs ───────────────────────
      - name: Get Application URLs
        run: |
          echo "=== DEPLOYMENT URLS ==="
          BACKEND_FQDN=$(az containerapp show --name ${{ env.BACKEND_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
          FRONTEND_FQDN=$(az containerapp show --name ${{ env.FRONTEND_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
          
          echo "Backend URL:  https://$BACKEND_FQDN"
          echo "Frontend URL: https://$FRONTEND_FQDN"
          echo ""
          echo "⚠️  IMPORTANT NEXT STEPS:"
          echo "1. Add BACKEND_FQDN as a GitHub secret with value: $BACKEND_FQDN"
          echo "2. Update backend FRONTEND_URL env var:"
          echo "   az containerapp update --name ${{ env.BACKEND_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --set-env-vars FRONTEND_URL=https://$FRONTEND_FQDN PUBLIC_URL=https://$FRONTEND_FQDN"
