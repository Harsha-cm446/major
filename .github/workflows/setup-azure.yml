# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Azure Infrastructure Setup â€” One-time setup script
# Run this once to create all Azure resources
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: Setup Azure Infrastructure

on:
  workflow_dispatch: # Manual trigger only

env:
  AZURE_RESOURCE_GROUP: ai-interview-rg
  LOCATION: eastasia                    # Allowed region for student subscription
  ACR_NAME: aiinterviewacr             # Must be globally unique
  CONTAINER_ENV_NAME: ai-interview-env
  BACKEND_APP_NAME: ai-interview-backend
  FRONTEND_APP_NAME: ai-interview-frontend

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # â”€â”€ 0. Register required resource providers â”€â”€
      - name: Register Resource Providers
        run: |
          for NS in Microsoft.ContainerRegistry Microsoft.App Microsoft.OperationalInsights; do
            echo "Registering $NS..."
            az provider register --namespace $NS
          done
          
          # Poll until all are registered (can take up to 10 minutes)
          for NS in Microsoft.ContainerRegistry Microsoft.App Microsoft.OperationalInsights; do
            echo "Waiting for $NS to be Registered..."
            for i in $(seq 1 60); do
              STATE=$(az provider show --namespace $NS --query "registrationState" -o tsv)
              echo "  $NS â†’ $STATE (attempt $i/60)"
              if [ "$STATE" = "Registered" ]; then
                break
              fi
              sleep 10
            done
          done
          echo "âœ… All resource providers registered"

      # â”€â”€ 1. Create Resource Group â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }}

      # â”€â”€ 2. Create Azure Container Registry (Basic = ~$5/month) â”€â”€
      - name: Create Container Registry
        run: |
          az acr create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.ACR_NAME }} \
            --sku Basic \
            --admin-enabled true

      # â”€â”€ 3. Create Container Apps Environment (free) â”€â”€
      - name: Create Container Apps Environment
        run: |
          az containerapp env create \
            --name ${{ env.CONTAINER_ENV_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }}

      # â”€â”€ 4. Create Backend Container App â”€â”€â”€â”€â”€â”€
      - name: Create Backend Container App
        run: |
          ACR_USER=$(az acr credential show --name ${{ env.ACR_NAME }} --query username -o tsv)
          ACR_PASS=$(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" -o tsv)
          
          for ATTEMPT in 1 2 3; do
            echo "ğŸ”„ Attempt $ATTEMPT/3 â€” Creating backend container app..."
            az containerapp create \
              --name ${{ env.BACKEND_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --environment ${{ env.CONTAINER_ENV_NAME }} \
              --image mcr.microsoft.com/k8se/quickstart:latest \
              --target-port 8000 \
              --ingress external \
              --min-replicas 0 \
              --max-replicas 1 \
              --cpu 1.0 \
              --memory 2.0Gi \
              --registry-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username "$ACR_USER" \
              --registry-password "$ACR_PASS" \
              --env-vars \
                MONGODB_URL="${{ secrets.MONGODB_URL }}" \
                DATABASE_NAME="ai_interview_platform" \
                JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
                JWT_ALGORITHM="HS256" \
                ACCESS_TOKEN_EXPIRE_MINUTES="1440" \
                GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
                GEMINI_MODEL="gemini-2.5-flash" \
                FRONTEND_URL="https://placeholder.azurecontainerapps.io" \
                EMAIL_PROVIDER="resend" \
                RESEND_API_KEY="${{ secrets.RESEND_API_KEY }}" \
              && echo "âœ… Backend created!" && break \
              || { echo "âš ï¸ Attempt $ATTEMPT failed, waiting 30s..."; sleep 30; }
          done

      # â”€â”€ 5. Create Frontend Container App â”€â”€â”€â”€â”€
      - name: Create Frontend Container App
        run: |
          ACR_USER=$(az acr credential show --name ${{ env.ACR_NAME }} --query username -o tsv)
          ACR_PASS=$(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" -o tsv)
          
          for ATTEMPT in 1 2 3; do
            echo "ğŸ”„ Attempt $ATTEMPT/3 â€” Creating frontend container app..."
            az containerapp create \
              --name ${{ env.FRONTEND_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --environment ${{ env.CONTAINER_ENV_NAME }} \
              --image mcr.microsoft.com/k8se/quickstart:latest \
              --target-port 80 \
              --ingress external \
              --min-replicas 0 \
              --max-replicas 1 \
              --cpu 0.25 \
              --memory 0.5Gi \
              --registry-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username "$ACR_USER" \
              --registry-password "$ACR_PASS" \
              && echo "âœ… Frontend created!" && break \
              || { echo "âš ï¸ Attempt $ATTEMPT failed, waiting 30s..."; sleep 30; }
          done

      # â”€â”€ 6. Output URLs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get Application URLs
        run: |
          echo "=== DEPLOYMENT URLS ==="
          BACKEND_FQDN=$(az containerapp show --name ${{ env.BACKEND_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
          FRONTEND_FQDN=$(az containerapp show --name ${{ env.FRONTEND_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
          
          echo "Backend URL:  https://$BACKEND_FQDN"
          echo "Frontend URL: https://$FRONTEND_FQDN"
          echo ""
          echo "âš ï¸  IMPORTANT NEXT STEPS:"
          echo "1. Add BACKEND_FQDN as a GitHub secret with value: $BACKEND_FQDN"
          echo "2. Update backend FRONTEND_URL env var:"
          echo "   az containerapp update --name ${{ env.BACKEND_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --set-env-vars FRONTEND_URL=https://$FRONTEND_FQDN PUBLIC_URL=https://$FRONTEND_FQDN"
